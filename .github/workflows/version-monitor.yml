name: Version Monitor

on:
  schedule:
    # Run every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not trigger release)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read
  actions: write

jobs:
  monitor:
    name: Monitor for new versions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Run Version Monitor
        run: |
          dotnet run --project nukeBuild -- VersionMonitor \
            --AzureBlobSasUrl "${{ secrets.AZURE_BLOB_SAS_URL }}" \
            --GitHubToken "${{ secrets.GITHUB_TOKEN }}" \
            --GitHubRepository "${{ github.repository }}" \
            --DryRun "${{ github.event.inputs.dry_run || 'false' }}"

      - name: Create issue on failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "Version Monitor Failed - $(date -u +'%Y-%m-%d %H:%M:%S UTC')" \
            --label "bug,automation" \
            --body "Version Monitor workflow failed at $(date -u +'%Y-%m-%d %H:%M:%S UTC').

          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Please check the logs for more details." \
            --repo "${{ github.repository }}" || echo "Failed to create issue"
